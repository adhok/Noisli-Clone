<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Focus | Bio-Dome</title>
    <style>
        /* RESET & BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: 'Segoe UI', Roboto, monospace;
            background-color: transparent;
            color: white;
            overflow-y: auto;
        }

        /* DYNAMIC BACKGROUND */
        .bg-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f1215 url('img/japan_temple.avif') center/cover;
            filter: brightness(0.4);
            z-index: -1;
        }

        /* MAIN LAYOUT */
        /* MAIN LAYOUT */
        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 130px 20px 40px;
            gap: 30px;
        }

        /* --- TIMER BAR STYLES --- */
        .timer-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 90px;
            background: rgba(60, 65, 70, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .timer-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .app-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: white;
            letter-spacing: 1px;
        }

        .timer-label {
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.75rem;
            color: #888;
            font-weight: bold;
        }

        .timer-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 3.5rem;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            line-height: 1;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .timer-controls-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .timer-settings {
            display: flex;
            gap: 15px;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #666;
            margin: 0;
        }

        .timer-input {
            width: 50px;
            padding: 4px 5px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #00ff88;
            text-align: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .timer-input:focus {
            outline: none;
            border-color: rgba(0, 255, 136, 0.4);
            background: rgba(0, 255, 136, 0.05);
        }

        .timer-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .btn-primary {
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.4);
            color: #00ff88;
        }

        .btn-primary:hover {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        /* --- VIEW SWITCHER --- */
        .view-switcher {
            display: flex;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50px;
            padding: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
        }

        .switch-btn {
            background: transparent;
            border: none;
            color: #888;
            padding: 10px 25px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .switch-btn.active {
            background: #00ff88;
            color: #0f1215;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        }

        .switch-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* --- SOUND GRID STYLES --- */
        .sound-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 700px;
        }

        .sound-card {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            height: 180px;
        }

        .sound-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        #card-brown {
            grid-column: 1 / -1;
            width: 100%;
            /* Was calc(50% - 10px), but in a 1fr grid, width:auto is smarter */
            justify-self: center;
            max-width: 340px;
            /* Roughly half of 700px grid minus gap */
        }

        .sound-card.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.08);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
        }

        .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
            transition: 0.3s;
            filter: grayscale(100%);
        }

        .sound-card.active .icon {
            opacity: 1;
            transform: scale(1.1);
            filter: grayscale(0%);
            text-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        }

        .status-text {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            color: #666;
            font-weight: bold;
        }

        .sound-card.active .status-text {
            color: #00ff88;
        }

        /* Volume Slider */
        .slider-wrapper {
            width: 100%;
            opacity: 0.3;
            transition: 0.3s;
            pointer-events: none;
        }

        .sound-card.active .slider-wrapper {
            opacity: 1;
            pointer-events: all;
        }

        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        /* --- GAME CONTAINER --- */
        .game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00bcd4;
            border-radius: 10px;
            overflow: hidden;
            display: none;
            /* Hidden by default */
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.2);
        }

        canvas {
            width: 100%;
            display: block;
        }

        .game-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            text-align: center;
            width: 100%;
        }

        .game-score {
            position: absolute;
            top: 10px;
            left: 15px;
            color: #00bcd4;
            font-family: monospace;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* --- STOP ALL BUTTON --- */
        .stop-all-btn {
            background: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.75rem;
            transition: 0.3s;
            font-weight: bold;
            margin-top: 20px;
        }

        .stop-all-btn:hover {
            background: #ff4444;
            color: white;
            box-shadow: 0 0 25px rgba(255, 68, 68, 0.4);
        }

        /* --- DATE TIME DISPLAY --- */
        .datetime-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.05);
            /* Transparent like sound cards */
            padding: 15px 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .dt-time {
            font-size: 1.5rem;
            color: #00ff88;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
            line-height: 1;
        }

        .dt-location {
            font-size: 0.9rem;
            color: #00bcd4;
            margin-bottom: 5px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.4);
            letter-spacing: 1px;
            text-transform: uppercase;
            min-height: 1.2em;
            /* Reserve space */
        }



        .location-btn {
            background: rgba(0, 188, 212, 0.2);
            border: 1px solid rgba(0, 188, 212, 0.5);
            color: #00bcd4;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            margin-bottom: 5px;
            transition: 0.2s;
        }

        .location-btn:hover {
            background: rgba(0, 188, 212, 0.4);
            color: white;
        }

        .dt-date {
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 900px) {
            .timer-bar {
                flex-direction: column;
                height: auto;
                padding: 15px;
                gap: 15px;
            }

            .timer-display {
                position: static;
                transform: none;
                margin: 10px 0;
            }
        }

        @media (max-width: 600px) {
            .sound-grid {
                grid-template-columns: 1fr;
            }

            #card-brown {
                max-width: 100%;
                /* Reset max-width for mobile */
            }

            .timer-display {
                font-size: 2.5rem;
            }

            .timer-controls-group {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }

            .timer-settings {
                justify-content: center;
            }

            .container {
                padding-top: 240px;
                /* Push content down below taller header */
            }

            .datetime-display {
                bottom: 10px;
                right: 10px;
                padding: 10px;
                left: 10px;
                /* Make it full width capability if needed or stick to right corner but smaller */
                text-align: center;
                backdrop-filter: blur(15px);
                /* Stronger blur for readability over potential content */
                background: rgba(0, 0, 0, 0.4);
                /* Slightly darker for legibility */
            }

            .game-container {
                max-width: 100%;
                border-width: 1px;
            }

            canvas {
                height: auto;
                /* Maintain aspect ratio handled by JS or CSS aspect-ratio if supported, 
                  but 100% width is key */
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {

            /* Mobile Landscape Fixes */
            .timer-bar {
                display: none;
                /* Hide header on very short landscape screens to save space */
            }

            .container {
                padding-top: 20px;
            }
        }

        /* --- MOBILE GAME CONTROLS --- */
        .mobile-controls {
            display: none;
            gap: 20px;
            margin-top: 15px;
            justify-content: center;
            width: 100%;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 188, 212, 0.5);
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .control-btn:active {
            background: rgba(0, 188, 212, 0.4);
            transform: scale(0.95);
        }

        .fire-btn {
            border-color: #ff00ff;
            background: rgba(255, 0, 255, 0.1);
        }

        .fire-btn:active {
            background: rgba(255, 0, 255, 0.4);
        }

        @media (max-width: 900px) {
            .mobile-controls {
                display: flex;
            }
        }

        /* --- BREATHING EXERCISE --- */
        .breathing-container {
            width: 100%;
            height: 400px;
            display: none;
            /* Toggled via JS */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .breath-circle-container {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breath-circle {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #00bcd4, #00ff88);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.4);
            /* Animation applied by JS class to control start/stop */
            opacity: 0.8;
            z-index: 1;
        }

        .breath-circle.animating {
            animation: breatheAnimation 13s ease-in-out infinite;
        }

        @keyframes breatheAnimation {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            38% {
                transform: scale(2.5);
                opacity: 0.4;
            }

            /* Breathe In (5s) */
            62% {
                transform: scale(2.5);
                opacity: 0.4;
            }

            /* Hold (3s) */
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            /* Breathe Out (5s) */
        }

        .breath-text {
            position: absolute;
            z-index: 2;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .breath-subtext {
            margin-top: 20px;
            color: #ccc;
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
    </style>
</head>

<body>

    <div class="bg-image"></div>

    <nav class="timer-bar">
        <div class="timer-info">
            <div class="app-title">ECO-FOCUS | BIO-DOME</div>
            <div class="timer-label" id="timer-mode">System Focus</div>
            <div class="session-count" id="session-count-display"
                style="font-size: 0.7rem; color: #00bcd4; margin-top: 5px; font-weight: bold; letter-spacing: 1px;">
                TOTAL SESSIONS: 0</div>
        </div>

        <div class="timer-display" id="time-display">25:00</div>

        <div class="timer-controls-group">
            <div class="timer-settings">
                <div class="setting-group">
                    <label class="setting-label">Work</label>
                    <input type="number" class="timer-input" id="work-duration" min="5" max="60" value="25"
                        onchange="updateWorkDuration(this.value)">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Break</label>
                    <input type="number" class="timer-input" id="break-duration" min="1" max="60" value="5"
                        onchange="updateBreakDuration(this.value)">
                </div>
            </div>

            <div class="timer-controls">
                <button class="btn btn-primary" id="start-btn" onclick="toggleTimer()">Start</button>
                <button class="btn" onclick="resetTimer()">Reset</button>
                <button class="btn" id="mode-btn" onclick="switchMode()">Break</button>
            </div>
        </div>
    </nav>

    <div class="container">

        <div class="view-switcher">
            <button class="switch-btn active" id="btn-view-audio" onclick="setView('audio')">Soundboard</button>
            <button class="switch-btn" id="btn-view-game" onclick="setView('game')" disabled>
                üëæ Break Game <span id="game-lock-status" style="font-size:0.8em; margin-left:5px;">(Locked)</span>
            </button>
            <button class="switch-btn" id="btn-view-breathing" onclick="setView('breathing')" disabled>
                üßò Breathe
            </button>
        </div>

        <div class="sound-grid" id="view-audio">

            <div class="sound-card" id="card-forest" onclick="toggleSound('forest', 'card-forest')">
                <div class="icon">üå≤</div>
                <div class="status-text">OFF</div>
                <div class="slider-wrapper" onclick="event.stopPropagation()">
                    <input type="range" min="0" max="1" step="0.01" value="0.5"
                        oninput="setVolume('forest', this.value)">
                </div>
                <audio id="forest" loop preload="auto" src="sounds/forest_sounds.mp3"></audio>
            </div>

            <div class="sound-card" id="card-rain" onclick="toggleSound('rain', 'card-rain')">
                <div class="icon">üåßÔ∏è</div>
                <div class="status-text">OFF</div>
                <div class="slider-wrapper" onclick="event.stopPropagation()">
                    <input type="range" min="0" max="1" step="0.01" value="0.5" oninput="setVolume('rain', this.value)">
                </div>
                <audio id="rain" loop preload="auto" src="sounds/rain_sounds.mp3"></audio>
            </div>

            <div class="sound-card" id="card-birds" onclick="toggleSound('birds', 'card-birds')">
                <div class="icon">ü¶ú</div>
                <div class="status-text">OFF</div>
                <div class="slider-wrapper" onclick="event.stopPropagation()">
                    <input type="range" min="0" max="1" step="0.01" value="0.5"
                        oninput="setVolume('birds', this.value)">
                </div>
                <audio id="birds" loop preload="auto" src="sounds/bird_sounds.mp3"></audio>
            </div>

            <div class="sound-card" id="card-water" onclick="toggleSound('water', 'card-water')">
                <div class="icon">üåä</div>
                <div class="status-text">OFF</div>
                <div class="slider-wrapper" onclick="event.stopPropagation()">
                    <input type="range" min="0" max="1" step="0.01" value="0.5"
                        oninput="setVolume('water', this.value)">
                </div>
                <audio id="water" loop preload="auto" src="sounds/wave_sounds.mp3"></audio>
            </div>

            <div class="sound-card" id="card-brown" onclick="toggleSound('brown', 'card-brown')">
                <div class="icon">üìª</div>
                <div class="status-text">OFF</div>
                <div class="slider-wrapper" onclick="event.stopPropagation()">
                    <input type="range" min="0" max="1" step="0.01" value="0.5"
                        oninput="setVolume('brown', this.value)">
                </div>
                <audio id="brown" loop preload="auto" src="sounds/brown_noise.mp3"></audio>
            </div>

        </div>

        <div class="game-container" id="view-game">
            <canvas id="gameCanvas" width="600" height="400"></canvas>
            <div class="game-overlay" id="game-start-msg">Press SPACE to Start</div>
            <div class="game-score">
                Score: <span id="score-display">0</span>
                <span id="high-score-wrapper" style="margin-left: 20px; font-size: 0.8em; color: #fff;">High Score:
                    <span id="high-score-display">0</span></span>
                <div id="wave-display" style="font-size: 0.8em; color: #ff00ff; margin-top:5px;">WAVE 1</div>
            </div>

            <!-- Touch Controls -->
            <div class="mobile-controls">
                <div class="control-btn" ontouchstart="setKey('ArrowLeft', true); event.preventDefault()"
                    ontouchend="setKey('ArrowLeft', false); event.preventDefault()">‚Üê</div>
                <div class="control-btn fire-btn" ontouchstart="handleMobileFire(); event.preventDefault()">üî•</div>
                <div class="control-btn" ontouchstart="setKey('ArrowRight', true); event.preventDefault()"
                    ontouchend="setKey('ArrowRight', false); event.preventDefault()">‚Üí</div>
            </div>
        </div>

        <!-- Breathing Exercise View -->
        <div class="breathing-container" id="view-breathing" style="display: none;">
            <div class="breath-circle-container">
                <div class="breath-circle"></div>
                <div class="breath-text" id="breath-instruction">Ready?</div>
            </div>
            <div class="breath-subtext">Follow the circle...</div>
        </div>

        <button class="stop-all-btn" onclick="stopAllSounds()">Shutdown Audio</button>

    </div>

    <!-- Date Time Display -->
    <div class="datetime-display" id="datetime-container">
        <div class="dt-location" id="dt-location">
            <button class="location-btn" onclick="fetchLocation()">Enable Location</button>
        </div>

        <div class="dt-time" id="dt-time">00:00:00</div>
        <div class="dt-date" id="dt-date">Loading...</div>
    </div>

    <script>
        // --- 1. LOCAL STORAGE & INIT ---
        window.onload = function () {
            if (localStorage.getItem('workDuration')) {
                const savedWork = localStorage.getItem('workDuration');
                document.getElementById('work-duration').value = savedWork;
                updateWorkDuration(savedWork);
            }
            if (localStorage.getItem('breakDuration')) {
                const savedBreak = localStorage.getItem('breakDuration');
                document.getElementById('break-duration').value = savedBreak;
                updateBreakDuration(savedBreak);
            }
            if (localStorage.getItem('totalSessions')) {
                totalSessions = parseInt(localStorage.getItem('totalSessions'));
                updateSessionDisplay();
            }
            if (localStorage.getItem('gameHighScore')) {
                gameHighScore = parseInt(localStorage.getItem('gameHighScore'));
                document.getElementById('high-score-display').innerText = gameHighScore;
            }

            // --- PREVENT ACCIDENTAL PAUSE (Earbuds/Media Keys) ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', function () { });
                navigator.mediaSession.setActionHandler('pause', function () {
                    console.log('External pause intercepted.');
                });
                navigator.mediaSession.setActionHandler('stop', function () { });
                navigator.mediaSession.setActionHandler('previoustrack', function () { });
                navigator.mediaSession.setActionHandler('nexttrack', function () { });
            }

            window.addEventListener('keydown', function (e) {
                if (e.key === 'MediaPlayPause' || e.key === 'MediaStop') {
                    e.preventDefault();
                }
            });

            // Request Notification Permission
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        // --- 2. AUDIO LOGIC ---

        function toggleSound(audioId, cardId) {
            const audio = document.getElementById(audioId);
            const card = document.getElementById(cardId);
            const statusText = card.querySelector('.status-text');

            if (!audio) return;

            const isActive = card.classList.contains('active');

            if (isActive) {
                audio.pause();
                audio.currentTime = 0;
                card.classList.remove('active');
                statusText.innerText = "OFF";
                audio.dataset.fading = "false";
            } else {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        card.classList.add('active');
                        statusText.innerText = "ACTIVE";
                        audio.dataset.fading = "false";
                        const slider = card.querySelector('input[type=range]');
                        audio.volume = slider.value;
                    }).catch(error => console.error("Playback failed:", error));
                }
            }
        }

        function setVolume(audioId, volValue) {
            const audio = document.getElementById(audioId);
            if (audio.dataset.fading !== "true") {
                audio.volume = volValue;
            }
        }

        function stopAllSounds() {
            ['forest', 'rain', 'birds', 'water', 'brown'].forEach(id => {
                const audio = document.getElementById(id);
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                    const card = document.getElementById('card-' + id);
                    if (card) {
                        card.classList.remove('active');
                        card.querySelector('.status-text').innerText = "OFF";
                    }
                }
            });
        }

        function fadeOutAndStop() {
            const activeAudios = [];
            document.querySelectorAll('audio').forEach(a => {
                if (!a.paused) {
                    a.dataset.fading = "true";
                    activeAudios.push(a);
                }
            });

            if (activeAudios.length === 0) return;

            let fadeInterval = setInterval(() => {
                let stillFading = false;
                activeAudios.forEach(a => {
                    if (a.volume > 0.05) {
                        a.volume -= 0.05;
                        stillFading = true;
                    } else {
                        a.volume = 0;
                    }
                });

                if (!stillFading) {
                    clearInterval(fadeInterval);
                    activeAudios.forEach(a => {
                        a.pause();
                        a.dataset.fading = "false";
                        const card = document.getElementById('card-' + a.id);
                        a.volume = card.querySelector('input').value;
                        card.classList.remove('active');
                        card.querySelector('.status-text').innerText = "OFF";
                    });
                }
            }, 100);
        }

        // --- 3. TIMER & STATE MANAGEMENT ---
        let timer;
        let isRunning = false;
        let timeLeft = 25 * 60;
        let isBreak = false;
        let workDuration = 25;
        let breakDuration = 5;
        let gameEnabled = false;
        let totalSessions = 0;

        const timeDisplay = document.getElementById('time-display');
        const startBtn = document.getElementById('start-btn');
        const modeLabel = document.getElementById('timer-mode');
        const modeBtn = document.getElementById('mode-btn');

        function showNotification(title, body) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, { body: body });
            }
        }

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            const timeString = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            timeDisplay.textContent = timeString;
            document.title = isRunning ? `(${timeString}) Eco-Focus` : "Eco-Focus | Bio-Dome";
        }

        function updateWorkDuration(value) {
            let duration = parseInt(value);
            if (duration < 5) duration = 5;
            workDuration = duration;
            localStorage.setItem('workDuration', duration);
            if (!isBreak && !isRunning) {
                timeLeft = workDuration * 60;
                updateDisplay();
            }
        }

        function updateBreakDuration(value) {
            let duration = parseInt(value);
            if (duration < 1) duration = 1;
            breakDuration = duration;
            localStorage.setItem('breakDuration', duration);
            if (isBreak && !isRunning) {
                timeLeft = breakDuration * 60;
                updateDisplay();
            }
        }

        function toggleTimer() {
            if (isRunning) {
                clearInterval(timer);
                startBtn.textContent = "Start";
                startBtn.classList.remove('btn-primary');
            } else {
                timer = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        updateDisplay();
                    } else {
                        clearInterval(timer);
                        isRunning = false;
                        startBtn.textContent = "Start";
                        startBtn.classList.remove('btn-primary');
                        fadeOutAndStop();
                        startBtn.classList.remove('btn-primary');
                        fadeOutAndStop();
                        if (!isBreak) {
                            // Work session finished
                            totalSessions++;
                            localStorage.setItem('totalSessions', totalSessions);
                            updateSessionDisplay();
                            showNotification("Focus Session Complete", "Great job! Take a break.");
                        } else {
                            // Break finished
                            showNotification("Break Over!", "Time to get back to work.");
                        }
                        if (isBreak) switchMode();
                    }
                }, 1000);
                startBtn.textContent = "Pause";
                startBtn.classList.add('btn-primary');
            }
            isRunning = !isRunning;
            updateDisplay();
        }

        function updateSessionDisplay() {
            document.getElementById('session-count-display').innerText = "TOTAL SESSIONS: " + totalSessions;
        }

        function resetTimer() {
            clearInterval(timer);
            isRunning = false;
            startBtn.textContent = "Start";
            startBtn.classList.remove('btn-primary');
            timeLeft = isBreak ? breakDuration * 60 : workDuration * 60;
            updateDisplay();
        }

        function switchMode() {
            isBreak = !isBreak;
            resetTimer();

            const gameBtn = document.getElementById('btn-view-game');
            const lockStatus = document.getElementById('game-lock-status');

            if (isBreak) {
                // BREAK MODE
                timeLeft = breakDuration * 60;
                modeLabel.textContent = "System Cool-down";
                modeLabel.style.color = "#00bcd4";
                modeBtn.textContent = "Back to Work";
                gameEnabled = true;

                document.getElementById('btn-view-game').disabled = false;
                document.getElementById('btn-view-breathing').disabled = false;

                lockStatus.innerText = "(Ready)";
                lockStatus.style.color = "#00bcd4";
            } else {
                // WORK MODE
                timeLeft = workDuration * 60;
                modeLabel.textContent = "System Focus";
                modeLabel.style.color = "#888";
                modeBtn.textContent = "Break";
                setView('audio'); // Force back to audio
                gameEnabled = false;

                document.getElementById('btn-view-game').disabled = true;
                document.getElementById('btn-view-breathing').disabled = true;

                lockStatus.innerText = "(Locked)";
                lockStatus.style.color = "#666";
            }
            updateDisplay();
        }

        function setView(viewName) {
            document.getElementById('view-audio').style.display = viewName === 'audio' ? 'grid' : 'none';
            document.getElementById('view-game').style.display = viewName === 'game' ? 'block' : 'none';
            document.getElementById('view-breathing').style.display = viewName === 'breathing' ? 'flex' : 'none';

            document.getElementById('btn-view-audio').classList.toggle('active', viewName === 'audio');
            document.getElementById('btn-view-game').classList.toggle('active', viewName === 'game');
            document.getElementById('btn-view-breathing').classList.toggle('active', viewName === 'breathing');

            // Handle Game State
            if (viewName === 'game' && gameEnabled) {
                initGame();
            } else {
                stopGame();
            }

            // Handle Breathing State
            if (viewName === 'breathing') {
                startBreathing();
            } else {
                stopBreathing();
            }
        }

        // --- BREATHING LOGIC ---
        let breathInterval;

        function startBreathing() {
            const circle = document.querySelector('.breath-circle');
            const text = document.getElementById('breath-instruction');

            circle.classList.add('animating');
            text.innerText = "Breathe In";

            // Sync text with CSS animation (13s total: 5s In, 3s Hold, 5s Out)

            let phase = 0;
            // Immediate start
            setTimeout(() => text.innerText = "Hold", 5000);
            setTimeout(() => text.innerText = "Breathe Out", 8000);

            breathInterval = setInterval(() => {
                text.innerText = "Breathe In";
                setTimeout(() => text.innerText = "Hold", 5000);
                setTimeout(() => text.innerText = "Breathe Out", 8000);
            }, 13000);
        }

        function stopBreathing() {
            const circle = document.querySelector('.breath-circle');
            circle.classList.remove('animating');
            clearInterval(breathInterval);
            document.getElementById('breath-instruction').innerText = "Ready?";
        }

        // --- 4. GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameLoopId;
        let score = 0;
        let frameCount = 0;
        let player = { x: 280, y: 360, w: 30, h: 20, color: '#00bcd4' };
        let bullets = [];
        let enemies = [];
        let keys = {};
        let gameRunning = false;
        let baseSpeed = 2;
        let gameLevel = 1;
        let gameHighScore = 0;

        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if (e.code === 'Space' && document.getElementById('view-game').style.display === 'block') {
                e.preventDefault();
                if (!gameRunning && gameEnabled) startGameLoop();
                else if (gameRunning) fireBullet();
            }
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        // Mobile Controls Helper
        function setKey(code, val) {
            keys[code] = val;
        }

        function handleMobileFire() {
            if (document.getElementById('view-game').style.display === 'block') {
                if (!gameRunning && gameEnabled) startGameLoop();
                else if (gameRunning) fireBullet();
            }
        }

        function initGame() {
            score = 0;
            frameCount = 0;
            baseSpeed = 2;
            gameLevel = 1;

            document.getElementById('score-display').innerText = score;
            document.getElementById('wave-display').innerText = "WAVE " + gameLevel;
            document.getElementById('game-start-msg').style.display = "block";
            document.getElementById('game-start-msg').innerText = "Press SPACE to Start";

            spawnWave(1);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            draw();
        }

        function spawnWave(level) {
            enemies = [];
            const pattern = (level - 1) % 4;

            // Speed increases with level
            baseSpeed = 2 + (level * 0.5);

            if (pattern === 0) {
                // Classic Grid
                for (let r = 0; r < 4; r++) {
                    for (let c = 0; c < 8; c++) {
                        createEnemy(50 + c * 60, 30 + r * 40);
                    }
                }
            } else if (pattern === 1) {
                // The Wedge (V-shape)
                for (let r = 0; r < 5; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (Math.abs(c - 4) <= r) {
                            createEnemy(50 + c * 55, 30 + r * 40);
                        }
                    }
                }
            } else if (pattern === 2) {
                // Split Columns
                for (let c = 0; c < 3; c++) {
                    // Left group
                    for (let r = 0; r < 6; r++) createEnemy(40 + c * 50, 30 + r * 40);
                    // Right group
                    for (let r = 0; r < 6; r++) createEnemy(400 + c * 50, 30 + r * 40);
                }
            } else {
                // Checkerboard
                for (let r = 0; r < 6; r++) {
                    for (let c = 0; c < 10; c++) {
                        if ((r + c) % 2 === 0) {
                            createEnemy(30 + c * 50, 30 + r * 35);
                        }
                    }
                }
            }
        }

        function createEnemy(x, y) {
            enemies.push({
                x: x, y: y, w: 30, h: 20,
                alive: true,
                mode: 'formation',
                formationX: x, formationY: y
            });
        }

        function startGameLoop() {
            if (!gameEnabled) return;

            // Auto-start timer if not running
            if (!isRunning) {
                toggleTimer();
            }

            gameRunning = true;
            document.getElementById('game-start-msg').style.display = "none";
            loop();
        }

        function stopGame() {
            gameRunning = false;
            cancelAnimationFrame(gameLoopId);
        }

        function fireBullet() {
            bullets.push({ x: player.x + 12, y: player.y, w: 6, h: 10 });
        }

        function updateGame() {
            frameCount++;

            // Player
            if (keys['ArrowLeft'] && player.x > 0) player.x -= 5;
            if (keys['ArrowRight'] && player.x < canvas.width - player.w) player.x += 5;

            // Bullets
            bullets.forEach((b, i) => {
                b.y -= 7;
                if (b.y < 0) bullets.splice(i, 1);
            });

            // Enemies Logic
            const globalSpeed = baseSpeed + (score / 100);
            const waveOffset = Math.sin(frameCount * 0.05) * 10;

            // Direction for formation (switch every 200 frames)
            let dir = Math.floor(frameCount / 200) % 2 === 0 ? 1 : -1;

            enemies.forEach(e => {
                if (!e.alive) return;

                if (e.mode === 'formation') {
                    e.x += globalSpeed * dir;
                    e.y = e.formationY + waveOffset; // Oscillation
                }

                if (e.mode === 'diving') {
                    e.y += globalSpeed * 2.5;
                    // Homing
                    if (e.x < player.x) e.x += 1; else e.x -= 1;
                    // Loop
                    if (e.y > canvas.height) {
                        e.mode = 'formation';
                        e.y = 0;
                    }
                }
            });

            // Trigger Random Dives
            if (frameCount % 100 === 0) {
                const living = enemies.filter(e => e.alive && e.mode === 'formation');
                if (living.length > 0) {
                    living[Math.floor(Math.random() * living.length)].mode = 'diving';
                }
            }

            // Collisions
            bullets.forEach((b, bi) => {
                enemies.forEach((e, ei) => {
                    if (e.alive && b.x < e.x + e.w && b.x + b.w > e.x &&
                        b.y < e.y + e.h && b.h + b.y > e.y) {
                        e.alive = false;
                        bullets.splice(bi, 1);
                        score += 10;
                        document.getElementById('score-display').innerText = score;

                        // High Score Check
                        if (score > gameHighScore) {
                            gameHighScore = score;
                            localStorage.setItem('gameHighScore', gameHighScore);
                            document.getElementById('high-score-display').innerText = gameHighScore;
                        }
                    }
                });
            });

            // Level Clear Check
            if (enemies.every(e => !e.alive)) {
                gameLevel++;
                document.getElementById('wave-display').innerText = "WAVE " + gameLevel;
                // Brief pause before spawn could be added here, currently instant
                spawnWave(gameLevel);
                // Bonus for clearing wave?
                score += 50;
                document.getElementById('score-display').innerText = score;
            }
        }

        function draw() {
            ctx.fillStyle = '#0f1215';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Player
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.w, player.h);

            // Bullets
            ctx.fillStyle = '#fff';
            bullets.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));

            // Enemies
            enemies.forEach(e => {
                if (e.alive) {
                    if (e.mode === 'diving') {
                        ctx.fillStyle = '#ff00ff'; // Purple Divers
                        ctx.fillRect(e.x, e.y, e.w, e.h);
                        ctx.fillStyle = '#fff'; // Big Eyes
                        ctx.fillRect(e.x + 5, e.y + 8, 8, 8);
                        ctx.fillRect(e.x + 18, e.y + 8, 8, 8);
                    } else {
                        ctx.fillStyle = '#ff4444'; // Red Standard
                        ctx.fillRect(e.x, e.y, e.w, e.h);
                        ctx.fillStyle = '#000'; // Small Eyes
                        ctx.fillRect(e.x + 5, e.y + 5, 5, 5);
                        ctx.fillRect(e.x + 20, e.y + 5, 5, 5);
                    }
                }
            });
        }

        function loop() {
            if (!gameRunning) return;
            updateGame();
            draw();
            gameLoopId = requestAnimationFrame(loop);
        }

        // --- 5. DATE TIME WIDGET ---
        function updateDateTimeWidget() {
            const now = new Date();

            // Time
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('dt-time').innerText = timeStr;

            // Date
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            const dateStr = now.toLocaleDateString('en-US', options);
            document.getElementById('dt-date').innerText = dateStr;
        }

        // Init and Interval
        updateDateTimeWidget();
        setInterval(updateDateTimeWidget, 1000);

        // Location Fetch
        function fetchLocation() {
            // Show loading state
            document.getElementById('dt-location').innerHTML = "Wait...";

            fetch('https://get.geojs.io/v1/ip/geo.json')
                .then(response => response.json())
                .then(data => {
                    const city = data.city;
                    const country = data.country; // or country_code
                    document.getElementById('dt-location').innerText = `${city}, ${country}`;
                })
                .catch(err => {
                    console.error("Location fetch failed", err);
                    document.getElementById('dt-location').innerText = "WORLDWIDE";
                });
        }

        // Removed auto-call: fetchLocation();

        updateDisplay();
    </script>
</body>

</html>